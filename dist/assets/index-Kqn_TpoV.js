(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const l of r.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&i(l)}).observe(document,{childList:!0,subtree:!0});function n(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(s){if(s.ep)return;s.ep=!0;const r=n(s);fetch(s.href,r)}})();const c=document.getElementById("questionnaireForm"),h=document.getElementById("alertPlaceholder"),b=document.getElementById("livingIssuesGroup"),L=document.getElementById("livingIssuesFeedback"),v=document.getElementById("propertyTypesGroup"),I=document.getElementById("propertyTypesFeedback"),$=document.getElementById("delinquencyPeriodWrapper"),a=document.getElementById("delinquencyPeriod"),u=document.getElementById("postalCode"),q=document.getElementById("prefecture"),S=document.getElementById("city"),k=document.getElementById("debugSection"),E=document.getElementById("debugPayload"),T={male:"男性",female:"女性",other:"その他",no_answer:"無回答"},w={employee:"会社員",executive:"会社役員",public_servant:"公務員",self_employed:"自営業",homemaker:"主夫・主婦",part_time:"アルバイト",student:"学生",other:"その他"},B={mortgage:"住宅ローン",unsecured_loan:"無担保ローン",inheritance:"相続",rent:"賃貸",other:"その他"},O={land:"土地",house:"戸建",apartment:"マンション",other:"その他"},C={no_delinquency:"滞納無し",delinquent:"滞納中",repayment_not_started:"返済開始未定"};function o(e){return e==null||e===""?"未入力":Array.isArray(e)?e.length>0?e.join("、"):"未入力":String(e)}function d(e,t){if(e==null)return"未入力";if(Array.isArray(e)){const i=e.map(s=>t[s]??s);return i.length>0?i.join("、"):"未入力"}const n=String(e);return t[n]??n}function j(e){const t="アンケートが送信されました",n=["以下の内容でアンケートを受け付けました。","",`名前（姓）：${o(e.lastName)}`,`名前（名）：${o(e.firstName)}`,`名前（フリガナ・セイ）：${o(e.lastNameKana)}`,`名前（フリガナ・メイ）：${o(e.firstNameKana)}`,`郵便番号：${o(e.postalCode)}`,`都道府県：${o(e.prefecture)}`,`市区町村：${o(e.city)}`,`番地：${o(e.street)}`,`建物名・部屋番号：${o(e.building)}`,`電話：${o(e.phone)}`,`メールアドレス：${o(e.email)}`,`性別：${d(e.gender,T)}`,`ご職業：${d(e.occupation,w)}`,`業種：${o(e.industry)}`,`現在のお住まい（複数選択）：${d(e.livingIssues,B)}`,`物件種別（複数選択）：${d(e.propertyTypes,O)}`,`敷地（m2）：${o(e.siteArea)}`,`築年数：${o(e.buildingAge)}`,`ローン残債（万円）：${o(e.loanBalance)}`,`債務状況：${d(e.debtStatus,C)}`,`滞納期間：${o(e.delinquencyPeriod)}`,`その他、ご質問・ご相談事項：${o(e.notes)}`];return{subject:t,body:n.join(`
`)}}function m(e,t){h&&(h.innerHTML=`
    <div class="alert alert-${t}" role="alert">
      ${e}
    </div>
  `)}function N(e,t,n){!e||!t||(e.classList.toggle("border",!n),e.classList.toggle("border-danger",!n),e.classList.toggle("p-2",!n),e.classList.toggle("rounded-2",!0),t.classList.toggle("d-none",n))}function p(e,t,n="1つ以上選択してください。"){if(!e)return!0;const i=e.querySelectorAll('input[type="checkbox"]'),s=Array.from(i).some(l=>l.checked),r=i[0];return r&&r.setCustomValidity(s?"":n),i.forEach(l=>{l.classList.toggle("is-invalid",!s),l.classList.remove("is-valid")}),N(e,t,s),s}function P(){const e=document.querySelector('input[name="debtStatus"]:checked');return e?e.value:""}function f(){if(!$||!a)return;const e=P()==="delinquent";$.classList.toggle("d-none",!e),a.toggleAttribute("required",e),e||(a.value="",a.classList.remove("is-invalid"))}function x(e){e.querySelectorAll("input, select, textarea").forEach(n=>{n.type==="checkbox"||n.type==="radio"||(n.checkValidity()?n.classList.remove("is-invalid"):n.classList.add("is-invalid"))})}async function D(e){if(!(!q||!S))try{const t=await fetch(`https://zipcloud.ibsnet.co.jp/api/search?zipcode=${e}`);if(!t.ok)return;const n=await t.json();if(n.status!==200||!n.results||n.results.length===0)return;const{address1:i,address2:s,address3:r}=n.results[0];q.value=i,S.value=`${s}${r}`}catch{}}document.querySelectorAll('input[name="debtStatus"]').forEach(e=>{e.addEventListener("change",f)});f();if(c){if(u){let e,t="";const n=()=>{if(!u)return;const i=u.value.replace(/\D/g,"");i.length!==7||i===t||(e&&window.clearTimeout(e),e=window.setTimeout(()=>{t=i,D(i)},300))};u.addEventListener("blur",n),u.addEventListener("input",n)}c.addEventListener("change",e=>{const t=e.target;t instanceof HTMLInputElement&&(t.type==="checkbox"&&t.name==="livingIssues"&&p(b,L),t.type==="checkbox"&&t.name==="propertyTypes"&&p(v,I))}),c.addEventListener("submit",async e=>{const t=p(b,L),n=p(v,I);f();const i=P()!=="delinquent"||a&&a.value.trim().length>0;if(a&&(a.setCustomValidity(i?"":"滞納期間を選択してください。"),a.classList.toggle("is-invalid",!i)),!c.checkValidity()||!t||!n||!i){e.preventDefault(),e.stopPropagation(),c.classList.add("was-validated"),x(c),c.reportValidity(),m("未入力の必須項目があります。入力内容をご確認ください。","danger");return}e.preventDefault(),c.classList.add("was-validated");const s=new FormData(c),r=Object.fromEntries(s.entries());r.livingIssues=s.getAll("livingIssues"),r.propertyTypes=s.getAll("propertyTypes");const l=JSON.stringify(r),g=j(r);E&&(E.textContent=JSON.stringify(r,null,2)),k&&k.classList.remove("d-none"),console.log("submit payload",r),console.log("email subject",g.subject),console.log("email body",g.body);const y=c.action;if(!y){m("送信先が設定されていません。","danger");return}try{if(!(await fetch(y,{method:"POST",headers:{"Content-Type":"application/json"},body:l})).ok)throw new Error("request failed");m("送信しました。ありがとうございました。","success"),c.reset(),c.classList.remove("was-validated"),f()}catch{m("送信に失敗しました。時間をおいて再度お試しください。","danger")}})}
